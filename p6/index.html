<html>
    <head>
        <title>Flight Delays</title>
        <style>
            h1 {text-align: center}
            h2 {text-align: center}
            div {text-align: center}
        </style>
    </head>
    <h1>How often are flights delayed?</h1>
    <div id="carrierChart"></div>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="js/dimple.v2.3.0.min.js"></script>
    <script type="text/javascript">
    d3.csv("/data/flight_data.csv", drawCarrierChart);
    
    function drawCarrierChart (data) {
        d3.select("#carrierChart")
            .append("h2")
            .text("Chance of Delay by Airline and Year")
        var svg = dimple.newSvg("#carrierChart", 800, 400);
        var carrierChart = new dimple.chart(svg, data);
        carrierChart.setBounds(90,30,520,330);
        var x = carrierChart.addTimeAxis("x", "Year", "%Y", "%Y");
        var y = carrierChart.addMeasureAxis("y", "DepDelay");
        y.tickFormat = ".0%"
        y.title = "% of Flights Delayed by More Than 15 Minutes"
        carrierChart.addSeries("UniqueCarrier", dimple.plot.bubble);
        var lineSeries = carrierChart.addSeries(null, dimple.plot.line);
        lineSeries.aggregate = dimple.aggregateMethod.avg;
        airlineLegend = carrierChart.addLegend(630, 0, 100, 380, "left");

        carrierChart.draw(800);

        // orphan legends from chart
        carrierChart.legends = [];

        // get a list of all of the filterValues
        var filterValues = dimple.getUniqueValues(data, "UniqueCarrier");
        var allValues = filterValues;

        airlineLegend.shapes.selectAll("rect")
            .on("click", function (e) {
                // This indicates whether the item is already visible or not
                var hide = false;
                var newFilters = [];
                // If the filters contain the clicked shape hide it
                filterValues.forEach(function (f) {
                    if (f === e.aggField.slice(-1)[0]) {
                    hide = true;
                    } else {
                        newFilters.push(f);
                    }
                }); 
                // Hide the shape or show it
                if (hide) {
                d3.select(this).style("opacity", 0.2);
                } else {
                    newFilters.push(e.aggField.slice(-1)[0]);
                    d3.select(this).style("opacity", 0.8);
                }
                // Update the filters
                filterValues = newFilters;
                // Filter the data
                carrierChart.data = dimple.filterData(data, "UniqueCarrier", filterValues);
                // Redraw chart
                carrierChart.draw(800);
                });
            
        svg.selectAll("title_text")
            .data(["Show/Hide All"])
            .enter()
            .append("text")
                .attr("x", 630)
                .attr("y", 400)
                .style("font-family", "sans-serif")
                .style("font-size", "10px")
                .style("color", "Blue")
                .text(function (d) { return d })
                .on("click", function (e) {
                    if (filterValues === allValues) {
                        filterValues = [];
                        carrierChart.data = dimple.filterData(data, "UniqueCarrier", filterValues);
                        airlineLegend.shapes.selectAll("rect")
                            .style("opacity", .2);
                        carrierChart.draw(800);
                    } else {
                        filterValues = allValues;
                        carrierChart.data = dimple.filterData(data, "UniqueCarrier", filterValues);
                        airlineLegend.shapes.selectAll("rect")
                            .style("opacity", .8);
                        carrierChart.draw(800);
                    }
                });
    }
    </script>
</html>